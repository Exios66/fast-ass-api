<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CSV API Diagnostics ‚Äî Enhanced Agent Endpoint Tester</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0f1724;
    --card: #0b1220;
    --muted: #94a3b8;
    --accent: #7c3aed;
    --ok: #10b981;
    --err: #ef4444;
    --warn: #f59e0b;
    --glass: rgba(255,255,255,0.02);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    --border: rgba(255,255,255,0.03);
    --hover: rgba(255,255,255,0.05);
  }
  
  [data-theme="light"] {
    --bg: #f8fafc;
    --card: #ffffff;
    --muted: #64748b;
    --accent: #7c3aed;
    --ok: #10b981;
    --err: #ef4444;
    --warn: #f59e0b;
    --glass: rgba(0,0,0,0.02);
    --border: rgba(0,0,0,0.1);
    --hover: rgba(0,0,0,0.05);
  }
  
  * { box-sizing: border-box; }
  
  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--muted);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    transition: background 0.3s, color 0.3s;
  }
  
  [data-theme="light"] html, [data-theme="light"] body {
    background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 60%);
  }
  
  .wrap {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }
  
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  
  header h1 {
    font-size: 24px;
    margin: 0;
    color: var(--accent);
  }
  
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    transition: all 0.2s;
  }
  
  .card:hover {
    box-shadow: 0 6px 24px rgba(0,0,0,0.15);
  }
  
  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  
  .col {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  input[type=text], input[type=number], select, textarea {
    background: var(--glass);
    border: 1px solid var(--border);
    color: inherit;
    padding: 10px 12px;
    border-radius: 8px;
    font-family: inherit;
    font-size: 14px;
    transition: all 0.2s;
    width: 100%;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }
  
  button {
    background: linear-gradient(90deg, var(--accent), #5b21b6);
    border: 0;
    padding: 10px 16px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  button:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
  }
  
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  button.ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: inherit;
  }
  
  button.ghost:hover:not(:disabled) {
    background: var(--hover);
  }
  
  button.warn {
    background: linear-gradient(90deg, #f97316, #ef4444);
  }
  
  button.small {
    font-size: 13px;
    padding: 6px 12px;
  }
  
  .muted {
    color: var(--muted);
    font-size: 13px;
  }
  
  .grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 16px;
  }
  
  pre {
    background: var(--glass);
    padding: 12px;
    border-radius: 8px;
    overflow: auto;
    font-family: var(--mono);
    font-size: 12px;
    border: 1px solid var(--border);
    max-height: 400px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  
  th, td {
    padding: 10px;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }
  
  th {
    font-weight: 600;
    color: var(--accent);
    position: sticky;
    top: 0;
    background: var(--card);
  }
  
  tr:hover {
    background: var(--hover);
  }
  
  .pill {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--glass);
    font-size: 12px;
    font-weight: 500;
  }
  
  .flex {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .status-ok { color: var(--ok); }
  .status-err { color: var(--err); }
  .status-warn { color: var(--warn); }
  
  .json-edit {
    width: 100%;
    min-height: 120px;
    resize: vertical;
    font-family: var(--mono);
    font-size: 12px;
  }
  
  .file-input {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  /* Loading spinner */
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Toast notifications */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .toast {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    min-width: 300px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideIn 0.3s ease-out;
  }
  
  .toast.success { border-left: 4px solid var(--ok); }
  .toast.error { border-left: 4px solid var(--err); }
  .toast.warning { border-left: 4px solid var(--warn); }
  .toast.info { border-left: 4px solid var(--accent); }
  
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* Tabs */
  .tabs {
    display: flex;
    gap: 8px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  
  .tab {
    padding: 10px 16px;
    background: transparent;
    border: 0;
    border-bottom: 2px solid transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  
  .tab-content {
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  /* Theme toggle */
  .theme-toggle {
    background: var(--glass);
    border: 1px solid var(--border);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .theme-toggle:hover {
    background: var(--hover);
  }
  
  /* Request history */
  .history-item {
    padding: 8px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .history-item:hover {
    background: var(--hover);
  }
  
  /* Code examples */
  .code-block {
    background: var(--glass);
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    font-family: var(--mono);
    font-size: 12px;
    position: relative;
  }
  
  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    padding: 4px 8px;
    font-size: 11px;
  }
  
  /* Charts */
  .chart-container {
    position: relative;
    height: 300px;
    margin: 16px 0;
  }
  
  /* Connection quality indicator */
  .connection-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
  }
  
  .connection-indicator.excellent { background: var(--ok); }
  .connection-indicator.good { background: #84cc16; }
  .connection-indicator.fair { background: var(--warn); }
  .connection-indicator.poor { background: var(--err); }
  
  /* Responsive */
  @media (max-width: 1200px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 768px) {
    header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .wrap {
      padding: 12px;
    }
    
    .card {
      padding: 12px;
    }
  }
  
  /* Advanced filter panel */
  .filter-panel {
    background: var(--glass);
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-top: 8px;
  }
  
  .filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr 2fr auto;
    gap: 8px;
    align-items: end;
    margin-bottom: 8px;
  }
  
  /* Query presets */
  .preset-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    border-bottom: 1px solid var(--border);
  }
  
  .preset-item:hover {
    background: var(--hover);
  }

  /* Sidebar Navigation */
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    background: var(--card);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    padding: 20px;
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .sidebar-toggle {
    position: fixed;
    left: 20px;
    top: 20px;
    z-index: 1001;
    background: var(--card);
    border: 1px solid var(--border);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
  }

  .sidebar-section {
    margin-bottom: 24px;
  }

  .sidebar-section h3 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    margin: 0 0 8px 0;
  }

  .sidebar-link {
    display: block;
    padding: 8px 12px;
    border-radius: 6px;
    color: var(--muted);
    text-decoration: none;
    transition: all 0.2s;
    margin-bottom: 4px;
    font-size: 14px;
  }

  .sidebar-link:hover {
    background: var(--hover);
    color: var(--accent);
  }

  .sidebar-link.active {
    background: var(--accent);
    color: white;
  }

  /* Breadcrumbs */
  .breadcrumbs {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 16px;
    font-size: 13px;
  }

  .breadcrumb-item {
    color: var(--muted);
  }

  .breadcrumb-item.active {
    color: var(--accent);
  }

  .breadcrumb-separator {
    color: var(--muted);
  }

  /* System Status */
  .system-status {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 8px 12px;
    background: var(--glass);
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-badge.healthy {
    background: rgba(16, 185, 129, 0.1);
    color: var(--ok);
  }

  .status-badge.unhealthy {
    background: rgba(239, 68, 68, 0.1);
    color: var(--err);
  }

  /* Schema Viewer */
  .schema-viewer {
    margin-top: 16px;
  }

  .schema-column {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid var(--border);
  }

  .schema-column-name {
    font-weight: 500;
    font-family: var(--mono);
  }

  .schema-column-type {
    color: var(--muted);
    font-size: 12px;
  }

  /* Metadata Manager */
  .metadata-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* Loading Skeleton */
  .skeleton {
    background: linear-gradient(90deg, var(--glass) 25%, var(--hover) 50%, var(--glass) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s ease-in-out infinite;
    border-radius: 4px;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Progress Bar */
  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--glass);
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #5b21b6);
    transition: width 0.3s ease;
  }

  /* Badge */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    background: var(--glass);
  }

  /* Endpoint Explorer */
  .endpoint-item {
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .endpoint-header {
    padding: 12px;
    background: var(--glass);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .endpoint-header:hover {
    background: var(--hover);
  }

  .endpoint-method {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    margin-right: 8px;
  }

  .endpoint-method.get { background: rgba(16, 185, 129, 0.2); color: var(--ok); }
  .endpoint-method.post { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
  .endpoint-method.put { background: rgba(245, 158, 11, 0.2); color: var(--warn); }
  .endpoint-method.delete { background: rgba(239, 68, 68, 0.2); color: var(--err); }

  .endpoint-content {
    padding: 12px;
    display: none;
  }

  .endpoint-item.expanded .endpoint-content {
    display: block;
  }

  /* Accessibility */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  button:focus-visible,
  input:focus-visible,
  select:focus-visible,
  textarea:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
    }

    .wrap {
      margin-left: 0;
    }

    .grid {
      grid-template-columns: 1fr;
    }
  }

  /* High contrast mode */
  @media (prefers-contrast: high) {
    :root {
      --border: rgba(255,255,255,0.2);
      --hover: rgba(255,255,255,0.1);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
</head>
<body data-theme="dark">
  <!-- Sidebar Navigation -->
  <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">‚ò∞</button>
  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <div class="sidebar-section">
      <h3>Quick Access</h3>
      <a href="#" class="sidebar-link" data-tab="query">Query & Browse</a>
      <a href="#" class="sidebar-link" data-tab="crud">CRUD Operations</a>
      <a href="#" class="sidebar-link" data-tab="bulk">Bulk Operations</a>
      <a href="#" class="sidebar-link" data-tab="export">Export & Import</a>
      <a href="#" class="sidebar-link" data-tab="metadata">Metadata</a>
      <a href="#" class="sidebar-link" data-tab="tokenizer">LLM Tokenizer</a>
      <a href="#" class="sidebar-link" data-tab="docs">API Docs</a>
      <a href="#" class="sidebar-link" data-tab="history">History</a>
    </div>
    <div class="sidebar-section">
      <h3>Health & Status</h3>
      <a href="#" class="sidebar-link" data-action="health">Health Check</a>
      <a href="#" class="sidebar-link" data-action="ready">Readiness</a>
      <a href="#" class="sidebar-link" data-action="metrics">Metrics</a>
    </div>
    <div class="sidebar-section">
      <h3>Endpoints</h3>
      <a href="#" class="sidebar-link" data-endpoint="datasets">List Datasets</a>
      <a href="#" class="sidebar-link" data-endpoint="schema">Get Schema</a>
      <a href="#" class="sidebar-link" data-endpoint="rows">Query Rows</a>
      <a href="#" class="sidebar-link" data-endpoint="create">Create Row</a>
      <a href="#" class="sidebar-link" data-endpoint="update">Update Row</a>
      <a href="#" class="sidebar-link" data-endpoint="delete">Delete Row</a>
    </div>
  </nav>

<div class="wrap" id="main-content">
  <header>
    <div>
      <h1>üìä CSV API Diagnostics ‚Äî Enhanced Agent Endpoint Tester</h1>
      <div class="muted">Comprehensive UI to interact with your Agent Data CSV API with advanced features</div>
    </div>
    <div class="flex">
      <button class="theme-toggle small" id="theme-toggle" title="Toggle theme" aria-label="Toggle theme">üåì</button>
      <div class="muted">Status: <span id="live-status" class="pill">idle</span></div>
    </div>
  </header>

  <!-- System Status Bar -->
  <div class="system-status" id="system-status" role="status" aria-live="polite">
    <div class="status-badge" id="health-badge">
      <span class="connection-indicator" id="health-indicator"></span>
      <span id="health-text">Checking...</span>
    </div>
    <div class="muted" id="health-details">System status will appear here</div>
  </div>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <span class="breadcrumb-item active">Home</span>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-item" id="breadcrumb-current">Dashboard</span>
  </nav>

  <div class="toast-container" id="toast-container"></div>

  <div class="card grid">
    <section>
      <!-- API Configuration -->
      <div class="card" style="margin-bottom: 16px;">
        <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <div class="col" style="flex: 1;">
            <label class="muted">API Base URL</label>
            <input id="api-base" type="text" placeholder="https://api.example.com (no trailing slash)" />
          </div>
          <div style="width: 200px;" class="col">
            <label class="muted">Actions</label>
            <div class="flex">
              <button id="btn-save" class="small">Save</button>
              <button id="btn-test" class="small ghost">Test</button>
              <button id="btn-refresh" class="small ghost">Refresh</button>
            </div>
          </div>
        </div>
        
        <div class="row" style="margin-top: 12px;">
          <div style="flex: 1;">
            <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
              <label class="muted">Datasets</label>
              <button id="btn-refresh-datasets" class="small ghost" title="Refresh datasets list">‚Üª</button>
            </div>
            <div id="datasets-list" class="card" style="padding: 8px; max-height: 200px; overflow: auto;"></div>
          </div>
          
          <div style="width: 360px;">
            <label class="muted">Connection Diagnostics</label>
            <div class="card" style="padding: 10px;">
              <div class="flex" style="margin-bottom: 8px;">
                <div><span class="connection-indicator" id="conn-indicator"></span>Quality: <span id="diag-quality" class="pill">‚Äî</span></div>
                <div>Latency: <span id="diag-latency" class="pill">‚Äî</span></div>
                <div>HTTP: <span id="diag-http" class="pill">‚Äî</span></div>
              </div>
              <div id="diag-message" class="muted" style="margin-bottom: 8px;">Press <strong>Test</strong> to run diagnostics.</div>
              <div class="flex">
                <button id="btn-diagnose" class="small">Full Diagnosis</button>
                <button id="btn-health" class="small ghost">Health</button>
                <button id="btn-ready" class="small ghost">Ready</button>
                <button id="btn-metrics" class="small ghost">Metrics</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs for different sections -->
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="query" role="tab" aria-selected="true">Query & Browse</button>
        <button class="tab" data-tab="crud" role="tab" aria-selected="false">CRUD Operations</button>
        <button class="tab" data-tab="bulk" role="tab" aria-selected="false">Bulk Operations</button>
        <button class="tab" data-tab="export" role="tab" aria-selected="false">Export & Import</button>
        <button class="tab" data-tab="metadata" role="tab" aria-selected="false">Metadata</button>
        <button class="tab" data-tab="tokenizer" role="tab" aria-selected="false">LLM Tokenizer</button>
        <button class="tab" data-tab="docs" role="tab" aria-selected="false">API Docs</button>
        <button class="tab" data-tab="history" role="tab" aria-selected="false">History</button>
      </div>

      <!-- Query Tab -->
      <div class="tab-content active" id="tab-query">
        <div class="card">
          <div class="row" style="margin-bottom: 12px;">
            <div style="flex: 1; min-width: 200px;">
              <label class="muted">Selected Dataset</label>
              <input id="selected-dataset" type="text" placeholder="Click a dataset or type name" />
            </div>
            <div style="width: 200px;">
              <label class="muted" for="q-limit">Limit</label>
              <input 
                id="q-limit"
                type="number"
                value="50"
                min="1"
                max="10000"
                placeholder="Limit (max rows)"
                title="Limit: Maximum number of rows to return"
                aria-label="Limit"
              />
            </div>
            <div style="width: 200px;">
              <label class="muted" for="q-offset">Offset</label>
              <input 
                id="q-offset"
                type="number"
                value="0"
                min="0"
                placeholder="Offset (start row)"
                title="Offset: How many rows to skip"
                aria-label="Offset"
              />
            </div>
            <div style="width: 150px;">
              <label class="muted" for="btn-query">&nbsp;</label>
              <button id="btn-query" type="button" class="small" style="width: 100%;" aria-label="Execute Query">Query</button>
            </div>
          </div>

          <div class="row" style="margin-bottom: 12px;">
            <div style="flex: 1;">
              <label class="muted">Global Search</label>
              <input id="q-search" type="text" placeholder="Search across all fields" />
            </div>
            <div style="width: 150px;">
              <label class="muted">Sort By</label>
              <input id="q-sort-by" type="text" placeholder="field name" />
            </div>
            <div style="width: 120px;">
              <label class="muted" for="q-sort-order">Order</label>
              <select id="q-sort-order" title="Sort order: Ascending or Descending" aria-label="Order">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
              </select>
            </div>
          </div>

          <div>
            <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
              <label class="muted">Advanced Filters</label>
              <button id="btn-add-filter" class="small ghost">+ Add Filter</button>
            </div>
            <div id="filter-container"></div>
          </div>

          <div style="margin-top: 16px;">
            <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
              <label class="muted">Query Presets</label>
              <button id="btn-save-preset" class="small ghost">Save Preset</button>
            </div>
            <div id="presets-list" class="card" style="max-height: 150px; overflow: auto;"></div>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <div class="flex" style="justify-content: space-between; margin-bottom: 12px;">
            <div>
              <label class="muted">Results: <span id="results-count">0</span> rows</label>
              <div id="pagination-info" class="muted" style="margin-top: 4px;"></div>
            </div>
            <div class="flex">
              <button id="btn-export-json" class="small ghost">Export JSON</button>
              <button id="btn-export-csv" class="small ghost">Export CSV</button>
              <button id="btn-copy-results" class="small ghost">Copy</button>
              <button id="btn-visualize" class="small ghost">Visualize</button>
            </div>
          </div>
          <div id="results" style="max-height: 600px; overflow: auto;"></div>
          <div id="chart-container" class="chart-container" style="display: none;"></div>
        </div>
      </div>

      <!-- CRUD Tab -->
      <div class="tab-content" id="tab-crud">
        <div class="card">
          <h3 style="margin-top: 0;">Create Row</h3>
          <textarea id="create-json" class="json-edit" placeholder='{"name":"Agent","role":"assistant","active":true}'></textarea>
          <div class="flex" style="margin-top: 8px;">
            <button id="btn-create" class="small">Create</button>
            <button id="btn-clear-create" class="small ghost">Clear</button>
            <button id="btn-template-create" class="small ghost">Load Template</button>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Update / Delete Row</h3>
          <input id="update-id" type="text" placeholder="Row ID" style="margin-bottom: 8px;" />
          <textarea id="update-json" class="json-edit" placeholder='{"notes":"updated","active":false}'></textarea>
          <div class="flex" style="margin-top: 8px;">
            <button id="btn-update" class="small">Update</button>
            <button id="btn-delete" class="small warn">Delete</button>
            <button id="btn-schema" class="small ghost">View Schema</button>
            <button id="btn-metadata" class="small ghost">View Metadata</button>
          </div>
        </div>

        <div class="card" style="margin-top: 16px; display: none;" id="schema-viewer-card">
          <div class="flex" style="justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0;">Dataset Schema</h3>
            <button id="btn-close-schema" class="small ghost">√ó</button>
          </div>
          <div id="schema-viewer" class="schema-viewer"></div>
        </div>
      </div>

      <!-- Bulk Tab -->
      <div class="tab-content" id="tab-bulk">
        <div class="card">
          <h3 style="margin-top: 0;">Bulk Create</h3>
          <textarea id="bulk-create-json" class="json-edit" placeholder='{"rows":[{"name":"Item 1"},{"name":"Item 2"}]}'></textarea>
          <button id="btn-bulk-create" class="small" style="margin-top: 8px;">Bulk Create</button>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Bulk Update</h3>
          <textarea id="bulk-update-json" class="json-edit" placeholder='{"updates":[{"id":"123","name":"Updated"}]}'></textarea>
          <button id="btn-bulk-update" class="small" style="margin-top: 8px;">Bulk Update</button>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Bulk Delete</h3>
          <textarea id="bulk-delete-json" class="json-edit" placeholder='{"ids":["123","456"]}'></textarea>
          <button id="btn-bulk-delete" class="small warn" style="margin-top: 8px;">Bulk Delete</button>
        </div>
      </div>

      <!-- Export Tab -->
      <div class="tab-content" id="tab-export">
        <div class="card">
          <h3 style="margin-top: 0;">Import CSV</h3>
          <div class="file-input">
            <input id="csv-file" type="file" accept=".csv,text/csv" />
            <select id="import-mode" aria-label="Import mode">
              <option value="append">Append</option>
              <option value="replace">Replace</option>
            </select>
            <button id="btn-import" class="small">Import</button>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Export Dataset</h3>
          <div class="flex">
            <button id="btn-export-csv-file" class="small">Export CSV</button>
            <button id="btn-export-json-file" class="small">Export JSON</button>
          </div>
        </div>
      </div>

      <!-- API Docs Tab -->
      <div class="tab-content" id="tab-docs" role="tabpanel">
        <div class="card">
          <div class="flex" style="justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0;">API Documentation</h3>
            <div class="flex">
              <input type="text" id="endpoint-search" placeholder="Search endpoints..." aria-label="Search endpoints" style="width: 200px; margin-right: 8px;" />
              <button id="btn-refresh-docs" class="small ghost">Refresh</button>
            </div>
          </div>
          <div id="api-docs" style="max-height: 600px; overflow: auto;"></div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Interactive Endpoint Explorer</h3>
          <div id="endpoint-explorer"></div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Code Examples</h3>
          <div class="tabs">
            <button class="tab small active" data-code-tab="curl">cURL</button>
            <button class="tab small" data-code-tab="python">Python</button>
            <button class="tab small" data-code-tab="javascript">JavaScript</button>
            <button class="tab small" data-code-tab="go">Go</button>
            <button class="tab small" data-code-tab="ruby">Ruby</button>
            <button class="tab small" data-code-tab="php">PHP</button>
          </div>
          <div id="code-examples"></div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Quick Start Guide</h3>
          <div id="quick-start" class="muted"></div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">FAQ</h3>
          <div id="faq" class="muted"></div>
        </div>
      </div>

      <!-- Tokenizer Tab -->
      <div class="tab-content" id="tab-tokenizer">
        <div class="card">
          <h3 style="margin-top: 0;">üî§ LLM Tokenizer</h3>
          <p class="muted" style="margin-bottom: 16px;">
            Understand how LLMs break down natural language into tokens. This tool helps you understand token context windows and optimize your prompts.
          </p>
          
          <div class="row" style="margin-bottom: 16px;">
            <div style="flex: 1;">
              <label class="muted">Select Model</label>
              <select id="tokenizer-model">
                <option value="gpt-4">GPT-4 (8,192 tokens)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo (128,000 tokens)</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (4,096 tokens)</option>
                <option value="gpt-3.5-turbo-16k">GPT-3.5 Turbo 16k (16,384 tokens)</option>
                <option value="text-davinci-003">Text Davinci 003 (4,097 tokens)</option>
                <option value="cl100k_base">cl100k_base (8,192 tokens)</option>
                <option value="p50k_base">p50k_base (2,048 tokens)</option>
                <option value="r50k_base">r50k_base (2,048 tokens)</option>
              </select>
            </div>
            <div style="width: 150px;">
              <label class="muted">&nbsp;</label>
              <button id="btn-tokenize" class="small" style="width: 100%;">Tokenize</button>
            </div>
          </div>

          <div class="card" style="margin-bottom: 16px;">
            <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
              <h4 style="margin: 0;">Available Models</h4>
              <button id="btn-refresh-models" class="small ghost">Refresh</button>
            </div>
            <div id="models-list" class="muted" style="font-size: 12px;">Loading models...</div>
          </div>

          <div class="card" style="margin-bottom: 16px;">
            <div class="flex" style="justify-content: space-between; margin-bottom: 8px;">
              <h4 style="margin: 0;">Offline Examples</h4>
              <button id="btn-load-offline-example" class="small ghost">Load Example</button>
            </div>
            <p class="muted" style="font-size: 12px; margin-bottom: 8px;">
              Try tokenizer with pre-canned examples from the tokenizer_examples.csv dataset. Works offline!
            </p>
            <select id="offline-examples-select" style="margin-bottom: 8px;" aria-label="Select offline example">
              <option value="">Select an example...</option>
            </select>
          </div>

          <div style="margin-bottom: 16px;">
            <label class="muted">Input Text</label>
            <textarea id="tokenizer-input" class="json-edit" style="min-height: 200px; font-family: inherit;" placeholder="Enter text to tokenize...&#10;&#10;Example:&#10;Hello! How are you today? This is a test of the tokenizer system."></textarea>
            <div class="flex" style="margin-top: 8px;">
              <button id="btn-clear-tokenizer" class="small ghost">Clear</button>
              <button id="btn-load-example" class="small ghost">Load Example</button>
              <button id="btn-copy-tokens" class="small ghost">Copy Tokens</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Token Statistics</h3>
          <div id="token-stats" class="row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
            <!-- Stats will be populated here -->
          </div>
          
          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0;">Context Window Usage</h4>
            <div id="context-window-bar" style="background: var(--glass); border-radius: 8px; height: 30px; position: relative; overflow: hidden; border: 1px solid var(--border);">
              <div id="context-window-fill" style="background: linear-gradient(90deg, var(--ok), var(--warn)); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;"></div>
            </div>
            <div id="context-window-info" class="muted" style="margin-top: 8px;"></div>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <div class="flex" style="justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0;">Token Breakdown</h3>
            <div class="flex">
              <button id="btn-show-tokens" class="small ghost">Show Tokens</button>
              <button id="btn-show-ids" class="small ghost">Show IDs</button>
              <button id="btn-export-tokens" class="small ghost">Export</button>
            </div>
          </div>
          <div id="token-breakdown" style="max-height: 400px; overflow: auto;">
            <div class="muted" style="text-align: center; padding: 40px;">Enter text and click "Tokenize" to see token breakdown</div>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h3 style="margin-top: 0;">Token Visualization</h3>
          <div id="token-visualization" style="background: var(--glass); padding: 16px; border-radius: 8px; border: 1px solid var(--border); min-height: 100px; font-family: var(--mono); font-size: 13px; line-height: 1.8;">
            <div class="muted" style="text-align: center; padding: 40px;">Token visualization will appear here</div>
          </div>
        </div>
      </div>

      <!-- Metadata Tab -->
      <div class="tab-content" id="tab-metadata" role="tabpanel">
        <div class="card">
          <h3 style="margin-top: 0;">Dataset Metadata</h3>
          <div class="row" style="margin-bottom: 16px;">
            <div style="flex: 1;">
              <label class="muted">Dataset Name</label>
              <input id="metadata-dataset" type="text" placeholder="Enter dataset name" />
            </div>
            <div style="width: 150px;">
              <label class="muted">&nbsp;</label>
              <button id="btn-load-metadata" class="small" style="width: 100%;">Load Metadata</button>
            </div>
          </div>

          <div id="metadata-display" class="card" style="margin-bottom: 16px; display: none;">
            <h4 style="margin-top: 0;">Current Metadata</h4>
            <div id="metadata-current" class="muted"></div>
          </div>

          <div class="card">
            <h4 style="margin-top: 0;">Update Metadata</h4>
            <div class="metadata-form">
              <div>
                <label class="muted">Description</label>
                <textarea id="metadata-description" class="json-edit" style="min-height: 80px;" placeholder="Dataset description"></textarea>
              </div>
              <div>
                <label class="muted">Schema Version</label>
                <input id="metadata-schema-version" type="text" placeholder="e.g., 1.0, 2.0" />
              </div>
              <div class="flex">
                <button id="btn-update-metadata" class="small">Update Metadata</button>
                <button id="btn-clear-metadata" class="small ghost">Clear</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- History Tab -->
      <div class="tab-content" id="tab-history" role="tabpanel">
        <div class="card">
          <div class="flex" style="justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0;">Request History</h3>
            <button id="btn-clear-history" class="small ghost">Clear History</button>
          </div>
          <div id="history-list" style="max-height: 600px; overflow: auto;"></div>
        </div>
      </div>
    </section>

    <aside>
      <div class="card" style="margin-bottom: 16px;">
        <label class="muted">Raw Request</label>
        <pre id="raw-request" style="height: 180px;">‚Äî</pre>
        <button class="copy-btn small ghost" onclick="copyToClipboard('raw-request')">Copy</button>
      </div>

      <div class="card" style="margin-bottom: 16px;">
        <label class="muted">Raw Response</label>
        <pre id="raw-response" style="height: 180px;">‚Äî</pre>
        <button class="copy-btn small ghost" onclick="copyToClipboard('raw-response')">Copy</button>
      </div>

      <div class="card">
        <label class="muted">Request Timing</label>
        <div id="timing-breakdown" class="muted" style="margin-top: 8px;"></div>
      </div>

      <div class="card" style="margin-top: 16px;">
        <label class="muted">Keyboard Shortcuts</label>
        <div class="muted" style="margin-top: 8px; font-size: 12px;">
          <div><kbd>Ctrl/Cmd + K</kbd> - Focus API URL</div>
          <div><kbd>Ctrl/Cmd + Enter</kbd> - Run Query</div>
          <div><kbd>Ctrl/Cmd + S</kbd> - Save URL</div>
          <div><kbd>Esc</kbd> - Clear results</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
(() => {
  // State management
  const state = {
    baseUrl: localStorage.getItem('csv_api_base') || '',
    datasets: [],
    currentDataset: '',
    requestHistory: JSON.parse(localStorage.getItem('request_history') || '[]'),
    queryPresets: JSON.parse(localStorage.getItem('query_presets') || '[]'),
    filters: [],
    currentResults: null,
    theme: localStorage.getItem('theme') || 'dark',
    currentSchema: null,
    currentMetadata: null,
    healthStatus: null,
    tokenizerModels: [],
    offlineExamples: [],
  };

  // Initialize theme
  document.body.setAttribute('data-theme', state.theme);

  // Toast notification system
  function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <span>${message}</span>
      <button class="small ghost" onclick="this.parentElement.remove()" style="margin-left: auto;">√ó</button>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
    return toast;
  }

  // Set status
  function setStatus(text, type = 'idle') {
    const el = document.getElementById('live-status');
    el.textContent = text;
    el.className = `pill ${type === 'ok' ? 'status-ok' : type === 'err' ? 'status-err' : ''}`;
  }

  // Copy to clipboard
  window.copyToClipboard = function(elementId) {
    const el = document.getElementById(elementId);
    const text = el.textContent;
    navigator.clipboard.writeText(text).then(() => {
      showToast('Copied to clipboard!', 'success', 2000);
    });
  };

  // API URL helper
  function apiUrl(path) {
    const base = (document.getElementById('api-base').value || state.baseUrl).replace(/\/$/, '');
    return base ? (base + path) : null;
  }

  // Run fetch with timing
  async function runFetch(method, path, {json = null, form = null, signal = null} = {}) {
    const url = apiUrl(path);
    if (!url) throw new Error('API base URL not set');
    
    const requestData = {method, url, body: json || (form ? '(form/file)' : null)};
    showRaw('raw-request', requestData);
    
    const timing = {
      start: performance.now(),
      dns: null,
      connect: null,
      response: null,
      end: null,
    };
    
    const opts = {method, headers: {}, signal};
    if (json) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(json);
    }
    if (form) opts.body = form;
    
    try {
      const t0 = performance.now();
      const resp = await fetch(url, opts);
      timing.response = performance.now() - t0;
      
      const contentType = resp.headers.get('content-type') || '';
      let payload;
      if (contentType.includes('application/json')) {
        payload = await resp.json();
      } else {
        payload = await resp.text();
      }
      timing.end = performance.now() - timing.start;
      
      showRaw('raw-response', {
        status: resp.status,
        statusText: resp.statusText,
        headers: Object.fromEntries(resp.headers.entries()),
        body: payload
      });
      
      updateTiming(timing);
      updateConnectionQuality(timing.response);
      
      // Save to history
      state.requestHistory.unshift({
        method,
        path,
        status: resp.status,
        timestamp: new Date().toISOString(),
        duration: timing.end,
      });
      if (state.requestHistory.length > 100) state.requestHistory.pop();
      localStorage.setItem('request_history', JSON.stringify(state.requestHistory));
      renderHistory();
      
      return {ok: resp.ok, status: resp.status, payload, resp, timing};
    } catch (err) {
      timing.end = performance.now() - timing.start;
      showRaw('raw-response', String(err));
      updateConnectionQuality(null);
      throw err;
    }
  }

  function showRaw(elementId, data) {
    const el = document.getElementById(elementId);
    el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
  }

  function updateTiming(timing) {
    const el = document.getElementById('timing-breakdown');
    el.innerHTML = `
      <div>Total: ${timing.end?.toFixed(2) || '‚Äî'} ms</div>
      <div>Response: ${timing.response?.toFixed(2) || '‚Äî'} ms</div>
    `;
  }

  function updateConnectionQuality(latency) {
    const indicator = document.getElementById('conn-indicator');
    const quality = document.getElementById('diag-quality');
    const latencyEl = document.getElementById('diag-latency');
    
    if (latency === null) {
      indicator.className = 'connection-indicator';
      quality.textContent = '‚Äî';
      latencyEl.textContent = '‚Äî';
      return;
    }
    
    latencyEl.textContent = `${Math.round(latency)} ms`;
    
    if (latency < 100) {
      indicator.className = 'connection-indicator excellent';
      quality.textContent = 'Excellent';
    } else if (latency < 300) {
      indicator.className = 'connection-indicator good';
      quality.textContent = 'Good';
    } else if (latency < 1000) {
      indicator.className = 'connection-indicator fair';
      quality.textContent = 'Fair';
    } else {
      indicator.className = 'connection-indicator poor';
      quality.textContent = 'Poor';
    }
  }

  // List datasets
  async function listDatasets() {
    try {
      setStatus('loading...', '');
      const res = await runFetch('GET', '/datasets');
      if (res.ok) {
        state.datasets = res.payload;
        renderDatasets();
        setStatus('datasets loaded', 'ok');
        showToast(`Loaded ${res.payload.length} datasets`, 'success');
      } else {
        setStatus('error', 'err');
        showToast('Failed to load datasets', 'error');
      }
    } catch (e) {
      setStatus('error', 'err');
      showToast('Network error: ' + e.message, 'error');
      console.error(e);
    }
  }

  function renderDatasets() {
    const container = document.getElementById('datasets-list');
    container.innerHTML = '';
    if (!state.datasets || state.datasets.length === 0) {
      container.innerHTML = '<div class="muted">No datasets found</div>';
      return;
    }
    state.datasets.forEach(fn => {
      const name = fn.replace(/\.csv$/i, '');
      const el = document.createElement('div');
      el.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 6px; border-bottom: 1px solid var(--border); cursor: pointer;';
      el.innerHTML = `
        <div style="font-size: 14px; flex: 1;">${name}</div>
        <div class="flex" style="gap: 4px;">
          <button class="small ghost" onclick="event.stopPropagation(); viewSchema('${name}');" title="View schema">üìã</button>
          <button class="small ghost" onclick="event.stopPropagation(); loadMetadataForDataset('${name}');" title="View metadata">‚ÑπÔ∏è</button>
        </div>
      `;
      el.onclick = () => {
        document.getElementById('selected-dataset').value = name;
        state.currentDataset = name;
        updateBreadcrumb(name);
      };
      container.appendChild(el);
    });
  }

  // Schema viewer
  async function viewSchema(datasetName) {
    const name = datasetName || document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset first', 'warning');
      return;
    }
    try {
      setStatus('loading schema...', '');
      const res = await runFetch('GET', `/datasets/${encodeURIComponent(name)}/schema`);
      if (res.ok) {
        state.currentSchema = res.payload;
        renderSchema(res.payload);
        document.getElementById('schema-viewer-card').style.display = 'block';
        showToast('Schema loaded', 'success');
        setStatus('schema loaded', 'ok');
      } else {
        showToast('Failed to load schema', 'error');
      }
    } catch (e) {
      showToast('Schema error: ' + e.message, 'error');
    }
  }

  function renderSchema(schema) {
    const container = document.getElementById('schema-viewer');
    if (!schema.columns || schema.columns.length === 0) {
      container.innerHTML = '<div class="muted">No columns found</div>';
      return;
    }
    let html = '<div class="schema-viewer">';
    schema.columns.forEach(col => {
      const inferredType = inferColumnType(col);
      html += `
        <div class="schema-column">
          <span class="schema-column-name">${escapeHtml(col)}</span>
          <span class="schema-column-type">${inferredType}</span>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  function inferColumnType(columnName) {
    const name = columnName.toLowerCase();
    if (name.includes('id') || name.includes('uuid')) return 'ID';
    if (name.includes('date') || name.includes('time') || name.includes('created') || name.includes('updated')) return 'Date/Time';
    if (name.includes('email')) return 'Email';
    if (name.includes('url') || name.includes('link')) return 'URL';
    if (name.includes('count') || name.includes('num') || name.includes('score') || name.includes('amount')) return 'Number';
    if (name.includes('active') || name.includes('enabled') || name.includes('status')) return 'Boolean';
    return 'String';
  }

  // Metadata management
  async function loadMetadataForDataset(datasetName) {
    const name = datasetName || document.getElementById('metadata-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Enter a dataset name', 'warning');
      return;
    }
    try {
      setStatus('loading metadata...', '');
      const res = await runFetch('GET', `/datasets/${encodeURIComponent(name)}/metadata`);
      if (res.ok) {
        state.currentMetadata = res.payload;
        renderMetadata(res.payload);
        document.getElementById('metadata-dataset').value = name;
        document.getElementById('metadata-display').style.display = 'block';
        showToast('Metadata loaded', 'success');
        setStatus('metadata loaded', 'ok');
      } else {
        showToast('Failed to load metadata', 'error');
      }
    } catch (e) {
      showToast('Metadata error: ' + e.message, 'error');
    }
  }

  function renderMetadata(metadata) {
    const container = document.getElementById('metadata-current');
    container.innerHTML = `
      <div><strong>Description:</strong> ${metadata.description || '(none)'}</div>
      <div><strong>Schema Version:</strong> ${metadata.schema_version || '1.0'}</div>
      <div><strong>Created:</strong> ${metadata.created_at ? new Date(metadata.created_at).toLocaleString() : '(unknown)'}</div>
      <div><strong>Updated:</strong> ${metadata.updated_at ? new Date(metadata.updated_at).toLocaleString() : '(unknown)'}</div>
    `;
    document.getElementById('metadata-description').value = metadata.description || '';
    document.getElementById('metadata-schema-version').value = metadata.schema_version || '';
  }

  async function updateMetadata() {
    const name = document.getElementById('metadata-dataset').value.trim();
    if (!name) {
      showToast('Enter a dataset name', 'warning');
      return;
    }
    const description = document.getElementById('metadata-description').value.trim();
    const schemaVersion = document.getElementById('metadata-schema-version').value.trim();
    const payload = {};
    if (description) payload.description = description;
    if (schemaVersion) payload.schema_version = schemaVersion;
    if (Object.keys(payload).length === 0) {
      showToast('Enter at least one field to update', 'warning');
      return;
    }
    try {
      setStatus('updating metadata...', '');
      const res = await runFetch('PUT', `/datasets/${encodeURIComponent(name)}/metadata`, {json: payload});
      if (res.ok) {
        showToast('Metadata updated', 'success');
        loadMetadataForDataset(name);
        setStatus('metadata updated', 'ok');
      } else {
        showToast('Failed to update metadata', 'error');
      }
    } catch (e) {
      showToast('Update error: ' + e.message, 'error');
    }
  }

  // Query rows
  async function queryRows() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset first', 'warning');
      return;
    }
    
    const params = new URLSearchParams();
    const search = document.getElementById('q-search').value;
    const limit = document.getElementById('q-limit').value;
    const offset = document.getElementById('q-offset').value;
    const sortBy = document.getElementById('q-sort-by').value;
    const sortOrder = document.getElementById('q-sort-order').value;
    
    if (search) params.set('search', search);
    if (limit) params.set('limit', limit);
    if (offset) params.set('offset', offset);
    if (sortBy) params.set('sort_by', sortBy);
    if (sortOrder) params.set('sort_order', sortOrder);
    
    // Add filters
    state.filters.forEach((f, i) => {
      if (f.field && f.operator && f.value) {
        params.set(`field`, f.field);
        params.set(`operator`, f.operator);
        params.set(`value`, f.value);
      }
    });
    
    const path = `/datasets/${encodeURIComponent(name)}/rows?${params.toString()}`;
    try {
      setStatus('querying...', '');
      const res = await runFetch('GET', path);
      if (res.ok) {
        state.currentResults = res.payload;
        renderResults(res.payload);
        setStatus('query complete', 'ok');
        showToast(`Found ${res.payload.total} rows`, 'success');
      } else {
        showToast(`Query failed: ${res.status}`, 'error');
      }
    } catch (e) {
      showToast('Query error: ' + e.message, 'error');
      console.error(e);
    }
  }

  function renderResults(payload) {
    const container = document.getElementById('results');
    const countEl = document.getElementById('results-count');
    const paginationEl = document.getElementById('pagination-info');
    
    countEl.textContent = payload.total || 0;
    
    if (payload.links) {
      const links = payload.links;
      paginationEl.innerHTML = `
        ${links.prev ? `<a href="#" onclick="event.preventDefault(); loadPage('${links.prev}');">‚Üê Prev</a>` : ''}
        ${links.next ? `<a href="#" onclick="event.preventDefault(); loadPage('${links.next}');">Next ‚Üí</a>` : ''}
      `;
    }
    
    container.innerHTML = '';
    if (!payload.rows || payload.rows.length === 0) {
      container.innerHTML = '<div class="muted">No results</div>';
      return;
    }
    
    const table = document.createElement('table');
    const headers = Object.keys(payload.rows[0]);
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr>' + headers.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr>';
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    payload.rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = headers.map(h => `<td>${escapeHtml(String(r[h] ?? ''))}</td>`).join('');
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
  }

  window.loadPage = async function(url) {
    const path = url.replace(/^https?:\/\/[^\/]+/, '');
    const res = await runFetch('GET', path);
    if (res.ok) {
      state.currentResults = res.payload;
      renderResults(res.payload);
    }
  };

  // CRUD operations
  async function createRow() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset', 'warning');
      return;
    }
    let body;
    try {
      body = JSON.parse(document.getElementById('create-json').value);
    } catch (e) {
      showToast('Invalid JSON', 'error');
      return;
    }
    try {
      const res = await runFetch('POST', `/datasets/${encodeURIComponent(name)}/rows`, {json: body});
      if (res.ok) {
        showToast('Row created successfully', 'success');
        queryRows();
      } else {
        showToast('Create failed: ' + JSON.stringify(res.payload), 'error');
      }
    } catch (e) {
      showToast('Create error: ' + e.message, 'error');
    }
  }

  async function updateRow() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    const id = document.getElementById('update-id').value.trim();
    if (!name || !id) {
      showToast('Enter dataset name and row ID', 'warning');
      return;
    }
    let body;
    try {
      body = JSON.parse(document.getElementById('update-json').value);
    } catch (e) {
      showToast('Invalid JSON', 'error');
      return;
    }
    try {
      const res = await runFetch('PUT', `/datasets/${encodeURIComponent(name)}/rows/${encodeURIComponent(id)}`, {json: body});
      if (res.ok) {
        showToast('Row updated', 'success');
        queryRows();
      } else {
        showToast('Update failed', 'error');
      }
    } catch (e) {
      showToast('Update error: ' + e.message, 'error');
    }
  }

  async function deleteRow() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    const id = document.getElementById('update-id').value.trim();
    if (!name || !id) {
      showToast('Enter dataset name and row ID', 'warning');
      return;
    }
    if (!confirm(`Delete row ${id} from ${name}?`)) return;
    try {
      const res = await runFetch('DELETE', `/datasets/${encodeURIComponent(name)}/rows/${encodeURIComponent(id)}`);
      if (res.ok || res.status === 204) {
        showToast('Row deleted', 'success');
        queryRows();
      } else {
        showToast('Delete failed', 'error');
      }
    } catch (e) {
      showToast('Delete error: ' + e.message, 'error');
    }
  }

  // Bulk operations
  async function bulkCreate() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset', 'warning');
      return;
    }
    let body;
    try {
      body = JSON.parse(document.getElementById('bulk-create-json').value);
    } catch (e) {
      showToast('Invalid JSON', 'error');
      return;
    }
    try {
      const res = await runFetch('POST', `/datasets/${encodeURIComponent(name)}/rows/bulk`, {json: body});
      if (res.ok) {
        showToast(`Created ${res.payload.created} rows`, 'success');
        queryRows();
      } else {
        showToast('Bulk create failed', 'error');
      }
    } catch (e) {
      showToast('Bulk create error: ' + e.message, 'error');
    }
  }

  async function bulkUpdate() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset', 'warning');
      return;
    }
    let body;
    try {
      body = JSON.parse(document.getElementById('bulk-update-json').value);
    } catch (e) {
      showToast('Invalid JSON', 'error');
      return;
    }
    try {
      const res = await runFetch('PUT', `/datasets/${encodeURIComponent(name)}/rows/bulk`, {json: body});
      if (res.ok) {
        showToast(`Updated ${res.payload.updated} rows`, 'success');
        queryRows();
      } else {
        showToast('Bulk update failed', 'error');
      }
    } catch (e) {
      showToast('Bulk update error: ' + e.message, 'error');
    }
  }

  async function bulkDelete() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset', 'warning');
      return;
    }
    let body;
    try {
      body = JSON.parse(document.getElementById('bulk-delete-json').value);
    } catch (e) {
      showToast('Invalid JSON', 'error');
      return;
    }
    if (!confirm(`Delete ${body.ids?.length || 0} rows?`)) return;
    try {
      const res = await runFetch('DELETE', `/datasets/${encodeURIComponent(name)}/rows/bulk`, {json: body});
      if (res.ok) {
        showToast(`Deleted ${res.payload.deleted} rows`, 'success');
        queryRows();
      } else {
        showToast('Bulk delete failed', 'error');
      }
    } catch (e) {
      showToast('Bulk delete error: ' + e.message, 'error');
    }
  }

  // Export
  async function exportJson() {
    if (!state.currentResults) {
      showToast('No results to export', 'warning');
      return;
    }
    const blob = new Blob([JSON.stringify(state.currentResults.rows, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${state.currentDataset || 'export'}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('JSON exported', 'success');
  }

  async function exportCsvFile() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset', 'warning');
      return;
    }
    const url = apiUrl(`/datasets/${encodeURIComponent(name)}/export?format=csv`);
    if (!url) {
      showToast('Set API base URL', 'warning');
      return;
    }
    window.open(url, '_blank');
    showToast('CSV export started', 'success');
  }

  async function exportJsonFile() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset', 'warning');
      return;
    }
    const url = apiUrl(`/datasets/${encodeURIComponent(name)}/export?format=json`);
    if (!url) {
      showToast('Set API base URL', 'warning');
      return;
    }
    try {
      const res = await fetch(url);
      const data = await res.json();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url2 = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url2;
      a.download = `${name}.json`;
      a.click();
      URL.revokeObjectURL(url2);
      showToast('JSON exported', 'success');
    } catch (e) {
      showToast('Export error: ' + e.message, 'error');
    }
  }

  // Import
  async function importCsv() {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (!name) {
      showToast('Select a dataset', 'warning');
      return;
    }
    const file = document.getElementById('csv-file').files[0];
    if (!file) {
      showToast('Choose a CSV file', 'warning');
      return;
    }
    const mode = document.getElementById('import-mode').value;
    const form = new FormData();
    form.append('file', file, file.name);
    const path = `/datasets/${encodeURIComponent(name)}/import?mode=${encodeURIComponent(mode)}`;
    try {
      const res = await runFetch('POST', path, {form});
      if (res.ok) {
        showToast('Import successful', 'success');
        queryRows();
      } else {
        showToast('Import failed', 'error');
      }
    } catch (e) {
      showToast('Import error: ' + e.message, 'error');
    }
  }

  // Health check
  async function healthCheck() {
    try {
      const res = await runFetch('GET', '/health');
      if (res.ok) {
        state.healthStatus = res.payload;
        updateHealthStatus(res.payload, true);
        showToast('Health check passed', 'success');
        showRaw('raw-response', res.payload);
      } else {
        updateHealthStatus(null, false);
      }
    } catch (e) {
      updateHealthStatus(null, false);
      showToast('Health check failed', 'error');
    }
  }

  async function readinessCheck() {
    try {
      const res = await runFetch('GET', '/health/ready');
      if (res.ok) {
        showToast('Service is ready', 'success');
        showRaw('raw-response', res.payload);
      } else {
        showToast('Service not ready', 'warning');
      }
    } catch (e) {
      showToast('Readiness check failed', 'error');
    }
  }

  function updateHealthStatus(health, isHealthy) {
    const badge = document.getElementById('health-badge');
    const indicator = document.getElementById('health-indicator');
    const text = document.getElementById('health-text');
    const details = document.getElementById('health-details');
    
    if (isHealthy && health) {
      badge.className = 'status-badge healthy';
      indicator.className = 'connection-indicator excellent';
      text.textContent = 'Healthy';
      details.textContent = `Version ${health.version || 'unknown'} | ${health.timestamp ? new Date(health.timestamp).toLocaleTimeString() : ''}`;
    } else {
      badge.className = 'status-badge unhealthy';
      indicator.className = 'connection-indicator poor';
      text.textContent = 'Unhealthy';
      details.textContent = 'Service unavailable';
    }
  }

  // Auto-refresh health status
  let healthInterval = null;
  function startHealthMonitoring() {
    if (healthInterval) clearInterval(healthInterval);
    healthCheck();
    healthInterval = setInterval(healthCheck, 30000); // Every 30 seconds
  }

  function stopHealthMonitoring() {
    if (healthInterval) {
      clearInterval(healthInterval);
      healthInterval = null;
    }
  }

  async function getMetrics() {
    try {
      const res = await runFetch('GET', '/metrics');
      if (res.ok) {
        showRaw('raw-response', res.payload);
      }
    } catch (e) {
      showToast('Failed to get metrics', 'error');
    }
  }

  // History
  function renderHistory() {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if (state.requestHistory.length === 0) {
      container.innerHTML = '<div class="muted">No history</div>';
      return;
    }
    state.requestHistory.forEach((item, i) => {
      const el = document.createElement('div');
      el.className = 'history-item';
      el.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${item.method}</strong> ${item.path}
            <div class="muted" style="font-size: 11px;">${new Date(item.timestamp).toLocaleString()}</div>
          </div>
          <div>
            <span class="pill ${item.status < 400 ? 'status-ok' : 'status-err'}">${item.status}</span>
            <span class="muted" style="font-size: 11px;">${item.duration?.toFixed(0)}ms</span>
          </div>
        </div>
      `;
      el.onclick = () => {
        // Could reload this request
      };
      container.appendChild(el);
    });
  }

  // Filters
  function addFilter() {
    state.filters.push({field: '', operator: 'eq', value: ''});
    renderFilters();
  }

  function renderFilters() {
    const container = document.getElementById('filter-container');
    container.innerHTML = '';
    state.filters.forEach((f, i) => {
      const row = document.createElement('div');
      row.className = 'filter-row';
      row.innerHTML = `
        <input type="text" placeholder="Field" value="${f.field}" onchange="state.filters[${i}].field = this.value" />
        <select onchange="state.filters[${i}].operator = this.value">
          <option value="eq" ${f.operator === 'eq' ? 'selected' : ''}>Equals</option>
          <option value="ne" ${f.operator === 'ne' ? 'selected' : ''}>Not equals</option>
          <option value="contains" ${f.operator === 'contains' ? 'selected' : ''}>Contains</option>
          <option value="regex" ${f.operator === 'regex' ? 'selected' : ''}>Regex</option>
          <option value="gt" ${f.operator === 'gt' ? 'selected' : ''}>Greater than</option>
          <option value="lt" ${f.operator === 'lt' ? 'selected' : ''}>Less than</option>
          <option value="date_after" ${f.operator === 'date_after' ? 'selected' : ''}>Date after</option>
          <option value="date_before" ${f.operator === 'date_before' ? 'selected' : ''}>Date before</option>
        </select>
        <input type="text" placeholder="Value" value="${f.value}" onchange="state.filters[${i}].value = this.value" />
        <button class="small warn" onclick="state.filters.splice(${i}, 1); renderFilters();">√ó</button>
      `;
      container.appendChild(row);
    });
  }

  // Presets
  function savePreset() {
    const name = prompt('Preset name:');
    if (!name) return;
    const preset = {
      name,
      dataset: document.getElementById('selected-dataset').value,
      search: document.getElementById('q-search').value,
      limit: document.getElementById('q-limit').value,
      filters: state.filters,
    };
    state.queryPresets.push(preset);
    localStorage.setItem('query_presets', JSON.stringify(state.queryPresets));
    renderPresets();
    showToast('Preset saved', 'success');
  }

  function renderPresets() {
    const container = document.getElementById('presets-list');
    container.innerHTML = '';
    state.queryPresets.forEach((p, i) => {
      const el = document.createElement('div');
      el.className = 'preset-item';
      el.innerHTML = `
        <div>
          <strong>${p.name}</strong>
          <div class="muted" style="font-size: 11px;">${p.dataset}</div>
        </div>
        <button class="small ghost" onclick="loadPreset(${i})">Load</button>
      `;
      container.appendChild(el);
    });
  }

  window.loadPreset = function(i) {
    const p = state.queryPresets[i];
    document.getElementById('selected-dataset').value = p.dataset || '';
    document.getElementById('q-search').value = p.search || '';
    document.getElementById('q-limit').value = p.limit || '50';
    state.filters = p.filters || [];
    renderFilters();
    queryRows();
  };

  // API Docs
  async function loadApiDocs() {
    try {
      const res = await runFetch('GET', '/openapi.json');
      if (res.ok) {
        const docs = res.payload;
        renderApiDocs(docs);
        renderEndpointExplorer(docs);
      }
    } catch (e) {
      document.getElementById('api-docs').innerHTML = '<div class="muted">Could not load API docs. Make sure the API server is running.</div>';
      document.getElementById('endpoint-explorer').innerHTML = '<div class="muted">Could not load endpoint explorer.</div>';
    }
  }

  function renderApiDocs(docs) {
    const container = document.getElementById('api-docs');
    container.innerHTML = `
      <div style="margin-bottom: 16px;">
        <h4>API Information</h4>
        <div class="muted">
          <div><strong>Title:</strong> ${docs.info?.title || 'N/A'}</div>
          <div><strong>Version:</strong> ${docs.info?.version || 'N/A'}</div>
          <div><strong>Base URL:</strong> ${docs.servers?.[0]?.url || 'N/A'}</div>
        </div>
      </div>
      <details>
        <summary style="cursor: pointer; margin-bottom: 8px;"><strong>Full OpenAPI Specification (JSON)</strong></summary>
        <pre style="max-height: 400px; overflow: auto;">${JSON.stringify(docs, null, 2)}</pre>
      </details>
    `;
  }

  function renderEndpointExplorer(docs) {
    const container = document.getElementById('endpoint-explorer');
    if (!docs.paths) {
      container.innerHTML = '<div class="muted">No endpoints found</div>';
      return;
    }
    let html = '';
    const searchTerm = document.getElementById('endpoint-search')?.value.toLowerCase() || '';
    Object.entries(docs.paths).forEach(([path, methods]) => {
      if (searchTerm && !path.toLowerCase().includes(searchTerm)) return;
      Object.entries(methods).forEach(([method, details]) => {
        if (searchTerm && !details.summary?.toLowerCase().includes(searchTerm)) return;
        html += `
          <div class="endpoint-item">
            <div class="endpoint-header" onclick="toggleEndpoint(this)">
              <div>
                <span class="endpoint-method ${method}">${method.toUpperCase()}</span>
                <strong>${path}</strong>
                <span class="muted" style="margin-left: 8px;">${details.summary || ''}</span>
              </div>
              <span>‚ñº</span>
            </div>
            <div class="endpoint-content">
              <div style="margin-bottom: 8px;"><strong>Description:</strong> ${details.description || details.summary || 'No description'}</div>
              ${details.parameters ? `
                <div style="margin-bottom: 8px;">
                  <strong>Parameters:</strong>
                  <ul style="margin: 4px 0; padding-left: 20px;">
                    ${details.parameters.map(p => `<li>${p.name} (${p.in}): ${p.description || ''}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              <div>
                <button class="small ghost" onclick="tryEndpoint('${method}', '${path}')">Try it out</button>
              </div>
            </div>
          </div>
        `;
      });
    });
    container.innerHTML = html || '<div class="muted">No endpoints match your search</div>';
  }

  function toggleEndpoint(header) {
    const item = header.closest('.endpoint-item');
    item.classList.toggle('expanded');
    const arrow = header.querySelector('span:last-child');
    arrow.textContent = item.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
  }

  function tryEndpoint(method, path) {
    showToast(`Would execute ${method.toUpperCase()} ${path}`, 'info');
    // Could implement actual try-it-out functionality here
  }

  // Sidebar navigation
  function initSidebar() {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('sidebar-toggle');
    const mainContent = document.getElementById('main-content');
    
    toggle.onclick = () => {
      sidebar.classList.toggle('open');
      if (window.innerWidth > 768) {
        mainContent.style.marginLeft = sidebar.classList.contains('open') ? '280px' : '0';
      }
    };

    // Close sidebar on mobile when clicking outside
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
        if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
          sidebar.classList.remove('open');
        }
      }
    });

    // Sidebar links
    document.querySelectorAll('.sidebar-link[data-tab]').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        const tab = link.dataset.tab;
        document.querySelector(`.tab[data-tab="${tab}"]`)?.click();
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('open');
        }
      };
    });

    document.querySelectorAll('.sidebar-link[data-action]').forEach(link => {
      link.onclick = (e) => {
        e.preventDefault();
        const action = link.dataset.action;
        if (action === 'health') healthCheck();
        else if (action === 'ready') readinessCheck();
        else if (action === 'metrics') getMetrics();
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('open');
        }
      };
    });
  }

  function updateBreadcrumb(current) {
    const breadcrumb = document.getElementById('breadcrumb-current');
    if (breadcrumb) {
      breadcrumb.textContent = current || 'Dashboard';
    }
  }

  function loadCodeExamples() {
    const base = apiUrl('') || 'https://api.example.com';
    const name = state.currentDataset || 'users';
    const examples = {
      curl: `# List datasets
curl "${base}/datasets"

# Query rows
curl "${base}/datasets/${name}/rows?search=test&limit=10"

# Create row
curl -X POST "${base}/datasets/${name}/rows" \\
  -H "Content-Type: application/json" \\
  -d '{"name":"Test","value":123}'

# Update row
curl -X PUT "${base}/datasets/${name}/rows/123" \\
  -H "Content-Type: application/json" \\
  -d '{"name":"Updated"}'

# Delete row
curl -X DELETE "${base}/datasets/${name}/rows/123"`,
      python: `import requests

base = "${base}"

# List datasets
r = requests.get(f"{base}/datasets")
print(r.json())

# Query rows
r = requests.get(f"{base}/datasets/${name}/rows", params={"search": "test", "limit": 10})
print(r.json())

# Create row
r = requests.post(f"{base}/datasets/${name}/rows", json={"name": "Test", "value": 123})
print(r.json())

# Update row
r = requests.put(f"{base}/datasets/${name}/rows/123", json={"name": "Updated"})
print(r.json())

# Delete row
r = requests.delete(f"{base}/datasets/${name}/rows/123")
print(r.status_code)`,
      javascript: `const base = "${base}";

// List datasets
fetch(\`\${base}/datasets\`)
  .then(r => r.json())
  .then(console.log);

// Query rows
fetch(\`\${base}/datasets/${name}/rows?search=test&limit=10\`)
  .then(r => r.json())
  .then(console.log);

// Create row
fetch(\`\${base}/datasets/${name}/rows\`, {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({name: "Test", value: 123})
})
  .then(r => r.json())
  .then(console.log);

// Update row
fetch(\`\${base}/datasets/${name}/rows/123\`, {
  method: 'PUT',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({name: "Updated"})
})
  .then(r => r.json())
  .then(console.log);

// Delete row
fetch(\`\${base}/datasets/${name}/rows/123\`, {method: 'DELETE'})
  .then(r => console.log(r.status));`,
      go: `package main

import (
    "bytes"
    "encoding/json"
    "fmt"
    "net/http"
)

const base = "${base}"

func main() {
    // List datasets
    resp, _ := http.Get(base + "/datasets")
    defer resp.Body.Close()
    
    // Query rows
    resp, _ = http.Get(base + "/datasets/${name}/rows?search=test&limit=10")
    defer resp.Body.Close()
    
    // Create row
    data := map[string]interface{}{"name": "Test", "value": 123}
    jsonData, _ := json.Marshal(data)
    resp, _ = http.Post(base+"/datasets/${name}/rows", "application/json", bytes.NewBuffer(jsonData))
    defer resp.Body.Close()
}`,
      ruby: `require 'net/http'
require 'json'
require 'uri'

base = "${base}"

# List datasets
uri = URI("#{base}/datasets")
response = Net::HTTP.get_response(uri)
puts JSON.parse(response.body)

# Query rows
uri = URI("#{base}/datasets/${name}/rows")
uri.query = URI.encode_www_form(search: "test", limit: 10)
response = Net::HTTP.get_response(uri)
puts JSON.parse(response.body)

# Create row
uri = URI("#{base}/datasets/${name}/rows")
http = Net::HTTP.new(uri.host, uri.port)
request = Net::HTTP::Post.new(uri)
request['Content-Type'] = 'application/json'
request.body = {name: "Test", value: 123}.to_json
response = http.request(request)
puts JSON.parse(response.body)`,
      php: `<?php
$base = "${base}";

// List datasets
$response = file_get_contents("$base/datasets");
$data = json_decode($response, true);
print_r($data);

// Query rows
$url = "$base/datasets/${name}/rows?" . http_build_query(['search' => 'test', 'limit' => 10]);
$response = file_get_contents($url);
$data = json_decode($response, true);
print_r($data);

// Create row
$ch = curl_init("$base/datasets/${name}/rows");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode(['name' => 'Test', 'value' => 123]));
$response = curl_exec($ch);
curl_close($ch);
echo $response;
?>`
    };
    
    const container = document.getElementById('code-examples');
    let currentTab = 'curl';
    container.innerHTML = `<div class="code-block"><pre id="code-content">${examples.curl}</pre><button class="copy-btn small ghost" onclick="copyToClipboard('code-content')">Copy</button></div>`;
    
    document.querySelectorAll('[data-code-tab]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('[data-code-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTab = btn.dataset.codeTab;
        document.getElementById('code-content').textContent = examples[currentTab];
      };
    });
  }

  function loadQuickStart() {
    document.getElementById('quick-start').innerHTML = `
      <ol>
        <li>Set your API base URL in the top field</li>
        <li>Click "Test" to verify connectivity</li>
        <li>Select a dataset from the list</li>
        <li>Use the Query tab to search and filter data</li>
        <li>Use CRUD Operations to create, update, or delete rows</li>
        <li>Use Bulk Operations for multiple rows at once</li>
        <li>Export data in CSV or JSON format</li>
      </ol>
    `;
  }

  function loadFAQ() {
    document.getElementById('faq').innerHTML = `
      <div style="margin-bottom: 16px;">
        <strong>Q: CORS errors?</strong><br>
        A: Make sure your API server has CORS enabled. Check the server configuration.
      </div>
      <div style="margin-bottom: 16px;">
        <strong>Q: How do I filter by date?</strong><br>
        A: Use the advanced filters with "date_after" or "date_before" operators. Dates should be in ISO format.
      </div>
      <div style="margin-bottom: 16px;">
        <strong>Q: Can I use regex?</strong><br>
        A: Yes! Use the "regex" operator in advanced filters.
      </div>
      <div style="margin-bottom: 16px;">
        <strong>Q: How do I export large datasets?</strong><br>
        A: Use pagination (limit/offset) or the export endpoints directly.
      </div>
    `;
  }

  // Theme toggle
  document.getElementById('theme-toggle').onclick = () => {
    state.theme = state.theme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', state.theme);
    localStorage.setItem('theme', state.theme);
  };

  // Tab switching
  document.querySelectorAll('.tab[data-tab]').forEach(btn => {
    btn.onclick = () => {
      const tabName = btn.dataset.tab;
      updateTabAria(tabName);
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      updateBreadcrumb(tabName.charAt(0).toUpperCase() + tabName.slice(1));
      
      if (tabName === 'docs') {
        loadApiDocs();
        loadCodeExamples();
        loadQuickStart();
        loadFAQ();
      } else if (tabName === 'history') {
        renderHistory();
      } else if (tabName === 'tokenizer') {
        loadTokenizerModels();
        loadOfflineExamples();
      } else if (tabName === 'metadata') {
        const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
        if (name) {
          document.getElementById('metadata-dataset').value = name;
          loadMetadataForDataset(name);
        }
      }
    };
  });
  
  // Set initial active tab
  updateTabAria('query');

  // Event handlers
  document.getElementById('api-base').value = state.baseUrl;
  document.getElementById('btn-save').onclick = () => {
    state.baseUrl = document.getElementById('api-base').value.trim();
    localStorage.setItem('csv_api_base', state.baseUrl);
    showToast('URL saved', 'success');
  };
  document.getElementById('btn-test').onclick = async () => {
    try {
      const res = await runFetch('GET', '/datasets');
      if (res.ok) {
        showToast('Connection successful', 'success');
        listDatasets();
      }
    } catch (e) {
      showToast('Connection failed: ' + e.message, 'error');
    }
  };
  document.getElementById('btn-refresh').onclick = listDatasets;
  document.getElementById('btn-query').onclick = queryRows;
  document.getElementById('btn-create').onclick = createRow;
  document.getElementById('btn-update').onclick = updateRow;
  document.getElementById('btn-delete').onclick = deleteRow;
  document.getElementById('btn-import').onclick = importCsv;
  document.getElementById('btn-bulk-create').onclick = bulkCreate;
  document.getElementById('btn-bulk-update').onclick = bulkUpdate;
  document.getElementById('btn-bulk-delete').onclick = bulkDelete;
  document.getElementById('btn-export-json').onclick = exportJson;
  document.getElementById('btn-export-csv').onclick = exportCsvFile;
  document.getElementById('btn-export-csv-file').onclick = exportCsvFile;
  document.getElementById('btn-export-json-file').onclick = exportJsonFile;
  document.getElementById('btn-health').onclick = healthCheck;
  document.getElementById('btn-ready').onclick = readinessCheck;
  document.getElementById('btn-metrics').onclick = getMetrics;
  
  // Enhanced error handling
  window.addEventListener('error', (e) => {
    console.error('Global error:', e.error);
    showToast('An error occurred. Check console for details.', 'error', 5000);
  });
  
  window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled promise rejection:', e.reason);
    showToast('Network error: ' + (e.reason?.message || 'Unknown error'), 'error', 5000);
  });
  document.getElementById('btn-add-filter').onclick = addFilter;
  document.getElementById('btn-save-preset').onclick = savePreset;
  document.getElementById('btn-clear-history').onclick = () => {
    state.requestHistory = [];
    localStorage.setItem('request_history', '[]');
    renderHistory();
    showToast('History cleared', 'success');
  };
  document.getElementById('btn-clear-create').onclick = () => {
    document.getElementById('create-json').value = '';
  };
  document.getElementById('btn-copy-results').onclick = () => {
    if (state.currentResults) {
      navigator.clipboard.writeText(JSON.stringify(state.currentResults.rows, null, 2));
      showToast('Results copied', 'success');
    }
  };

  // Tokenizer event handlers
  document.getElementById('btn-tokenize').onclick = tokenizeText;
  document.getElementById('btn-clear-tokenizer').onclick = () => {
    document.getElementById('tokenizer-input').value = '';
    tokenizerState.currentResult = null;
    document.getElementById('token-stats').innerHTML = '';
    document.getElementById('token-breakdown').innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">Enter text and click "Tokenize" to see token breakdown</div>';
    document.getElementById('token-visualization').innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">Token visualization will appear here</div>';
  };
  document.getElementById('btn-load-example').onclick = loadTokenizerExample;
  document.getElementById('btn-copy-tokens').onclick = copyTokens;
  document.getElementById('btn-export-tokens').onclick = exportTokens;
  document.getElementById('btn-show-tokens').onclick = () => {
    tokenizerState.showTokens = true;
    tokenizerState.showIds = false;
    if (tokenizerState.currentResult) {
      renderTokenBreakdown(tokenizerState.currentResult);
    }
  };
  document.getElementById('btn-show-ids').onclick = () => {
    tokenizerState.showIds = true;
    if (tokenizerState.currentResult) {
      const container = document.getElementById('token-breakdown');
      container.innerHTML = `<pre>${JSON.stringify(tokenizerState.currentResult.token_ids, null, 2)}</pre>`;
    }
  };

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('api-base').focus();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      queryRows();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      document.getElementById('btn-save').click();
    }
    if (e.key === 'Escape') {
      document.getElementById('results').innerHTML = '';
    }
  });

  // Initialize
  initSidebar();
  renderPresets();
  if (state.baseUrl) {
    listDatasets();
    startHealthMonitoring();
  }
  
  // Load offline examples on tokenizer tab
  document.getElementById('offline-examples-select').onchange = loadOfflineExample;
  
  // Enhanced event handlers
  document.getElementById('btn-schema').onclick = () => viewSchema();
  document.getElementById('btn-close-schema').onclick = () => {
    document.getElementById('schema-viewer-card').style.display = 'none';
  };
  document.getElementById('btn-metadata').onclick = () => {
    const name = document.getElementById('selected-dataset').value.trim() || state.currentDataset;
    if (name) {
      document.getElementById('metadata-dataset').value = name;
      loadMetadataForDataset(name);
      // Switch to metadata tab
      document.querySelector('.tab[data-tab="metadata"]')?.click();
    } else {
      showToast('Select a dataset first', 'warning');
    }
  };
  document.getElementById('btn-load-metadata').onclick = () => loadMetadataForDataset();
  document.getElementById('btn-update-metadata').onclick = updateMetadata;
  document.getElementById('btn-clear-metadata').onclick = () => {
    document.getElementById('metadata-description').value = '';
    document.getElementById('metadata-schema-version').value = '';
  };
  document.getElementById('btn-refresh-datasets').onclick = listDatasets;
  document.getElementById('btn-refresh-models').onclick = loadTokenizerModels;
  document.getElementById('btn-load-offline-example').onclick = loadOfflineExample;
  document.getElementById('btn-refresh-docs').onclick = loadApiDocs;
  document.getElementById('endpoint-search')?.addEventListener('input', (e) => {
    // Debounce search
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(() => {
      const res = runFetch('GET', '/openapi.json').then(r => {
        if (r.ok) renderEndpointExplorer(r.payload);
      }).catch(() => {});
    }, 300);
  });
  
  // Enhanced tab switching
  document.querySelectorAll('.tab[data-tab]').forEach(btn => {
    btn.setAttribute('role', 'tab');
    btn.setAttribute('aria-selected', 'false');
  });
  
  // Update tab ARIA attributes
  const updateTabAria = (activeTab) => {
    document.querySelectorAll('.tab[data-tab]').forEach(tab => {
      const isActive = tab.dataset.tab === activeTab;
      tab.setAttribute('aria-selected', isActive);
      tab.classList.toggle('active', isActive);
    });
    document.querySelectorAll('.tab-content').forEach(content => {
      content.setAttribute('role', 'tabpanel');
      content.setAttribute('aria-hidden', content.classList.contains('active') ? 'false' : 'true');
    });
  };

  // Tokenizer functions
  let tokenizerState = {
    currentResult: null,
    showTokens: true,
    showIds: false,
  };

  async function loadTokenizerModels() {
    try {
      const res = await runFetch('GET', '/tokenize/models');
      if (res.ok && res.payload.available) {
        state.tokenizerModels = res.payload.models || [];
        renderTokenizerModels(state.tokenizerModels);
        updateModelSelector(state.tokenizerModels);
        showToast('Models loaded', 'success');
      } else {
        showToast('Tokenizer service not available', 'warning');
        // Load fallback models
        loadFallbackModels();
      }
    } catch (e) {
      showToast('Could not load tokenizer models, using fallback', 'warning');
      loadFallbackModels();
    }
  }

  function renderTokenizerModels(models) {
    const container = document.getElementById('models-list');
    if (!models || models.length === 0) {
      container.innerHTML = '<div class="muted">No models available</div>';
      return;
    }
    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 8px;">';
    models.forEach(model => {
      html += `
        <div class="card" style="padding: 8px;">
          <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(model.model)}</div>
          <div class="muted" style="font-size: 11px;">
            Encoding: ${escapeHtml(model.encoding)}<br>
            Context: ${model.context_window.toLocaleString()} tokens
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  function updateModelSelector(models) {
    const selector = document.getElementById('tokenizer-model');
    const currentValue = selector.value;
    selector.innerHTML = '';
    models.forEach(model => {
      const option = document.createElement('option');
      option.value = model.model;
      option.textContent = `${model.model} (${model.context_window.toLocaleString()} tokens)`;
      if (model.model === currentValue) option.selected = true;
      selector.appendChild(option);
    });
  }

  function loadFallbackModels() {
    const fallbackModels = [
      {model: 'gpt-4', encoding: 'cl100k_base', context_window: 8192},
      {model: 'gpt-4-turbo', encoding: 'cl100k_base', context_window: 128000},
      {model: 'gpt-3.5-turbo', encoding: 'cl100k_base', context_window: 4096},
      {model: 'gpt-3.5-turbo-16k', encoding: 'cl100k_base', context_window: 16384},
    ];
    state.tokenizerModels = fallbackModels;
    renderTokenizerModels(fallbackModels);
  }

  // Offline tokenizer examples
  async function loadOfflineExamples() {
    try {
      const name = 'tokenizer_examples';
      const res = await runFetch('GET', `/datasets/${encodeURIComponent(name)}/rows?limit=100`);
      if (res.ok && res.payload.rows) {
        state.offlineExamples = res.payload.rows;
        renderOfflineExamples(res.payload.rows);
      } else {
        // Create fallback examples
        state.offlineExamples = [
          {question: 'What is AI?', response: 'Artificial intelligence is...', model: 'gpt-4', token_count: 45},
          {question: 'How does ML work?', response: 'Machine learning is...', model: 'gpt-4', token_count: 52},
        ];
        renderOfflineExamples(state.offlineExamples);
      }
    } catch (e) {
      // Use fallback examples
      state.offlineExamples = [
        {question: 'What is AI?', response: 'Artificial intelligence is the simulation of human intelligence in machines.', model: 'gpt-4', token_count: 45},
        {question: 'How does ML work?', response: 'Machine learning enables systems to learn from experience without explicit programming.', model: 'gpt-4', token_count: 52},
      ];
      renderOfflineExamples(state.offlineExamples);
    }
  }

  function renderOfflineExamples(examples) {
    const selector = document.getElementById('offline-examples-select');
    selector.innerHTML = '<option value="">Select an example...</option>';
    examples.forEach((ex, i) => {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${ex.question || ex.response?.substring(0, 50) || 'Example ' + (i + 1)} (${ex.model || 'gpt-4'})`;
      selector.appendChild(option);
    });
  }

  function loadOfflineExample() {
    const index = document.getElementById('offline-examples-select').value;
    if (index === '' || !state.offlineExamples[index]) {
      showToast('Select an example first', 'warning');
      return;
    }
    const example = state.offlineExamples[index];
    const text = example.question ? `${example.question}\n\n${example.response}` : example.response;
    document.getElementById('tokenizer-input').value = text;
    if (example.model) {
      document.getElementById('tokenizer-model').value = example.model;
    }
    showToast('Example loaded', 'success');
  }

  async function tokenizeText() {
    const text = document.getElementById('tokenizer-input').value.trim();
    const model = document.getElementById('tokenizer-model').value;

    if (!text) {
      showToast('Enter text to tokenize', 'warning');
      return;
    }

    try {
      setStatus('tokenizing...', '');
      const res = await runFetch('POST', '/tokenize', {
        json: { text, model }
      });

      if (res.ok) {
        tokenizerState.currentResult = res.payload;
        renderTokenStats(res.payload);
        renderTokenBreakdown(res.payload);
        renderTokenVisualization(res.payload);
        setStatus('tokenized', 'ok');
        showToast(`Tokenized: ${res.payload.token_count} tokens`, 'success');
      } else {
        showToast('Tokenization failed', 'error');
      }
    } catch (e) {
      showToast('Tokenization error: ' + e.message, 'error');
      setStatus('error', 'err');
    }
  }

  function renderTokenStats(data) {
    const container = document.getElementById('token-stats');
    container.innerHTML = `
      <div class="card" style="padding: 12px;">
        <div class="muted" style="font-size: 11px; margin-bottom: 4px;">Token Count</div>
        <div style="font-size: 24px; font-weight: 600; color: var(--accent);">${data.token_count.toLocaleString()}</div>
      </div>
      <div class="card" style="padding: 12px;">
        <div class="muted" style="font-size: 11px; margin-bottom: 4px;">Character Count</div>
        <div style="font-size: 24px; font-weight: 600;">${data.character_count.toLocaleString()}</div>
      </div>
      <div class="card" style="padding: 12px;">
        <div class="muted" style="font-size: 11px; margin-bottom: 4px;">Word Count</div>
        <div style="font-size: 24px; font-weight: 600;">${data.word_count.toLocaleString()}</div>
      </div>
      <div class="card" style="padding: 12px;">
        <div class="muted" style="font-size: 11px; margin-bottom: 4px;">Tokens/Character</div>
        <div style="font-size: 24px; font-weight: 600;">${data.tokens_per_character.toFixed(3)}</div>
      </div>
      <div class="card" style="padding: 12px;">
        <div class="muted" style="font-size: 11px; margin-bottom: 4px;">Tokens/Word</div>
        <div style="font-size: 24px; font-weight: 600;">${data.tokens_per_word.toFixed(2)}</div>
      </div>
      <div class="card" style="padding: 12px;">
        <div class="muted" style="font-size: 11px; margin-bottom: 4px;">Est. Cost (USD)</div>
        <div style="font-size: 24px; font-weight: 600; color: var(--ok);">$${data.estimated_cost_usd.toFixed(6)}</div>
      </div>
    `;

    // Update context window bar
    const percent = data.context_usage_percent;
    const fill = document.getElementById('context-window-fill');
    fill.style.width = `${Math.min(percent, 100)}%`;
    fill.textContent = `${percent.toFixed(1)}%`;
    
    if (percent > 90) {
      fill.style.background = 'linear-gradient(90deg, var(--warn), var(--err))';
    } else if (percent > 70) {
      fill.style.background = 'linear-gradient(90deg, var(--ok), var(--warn))';
    } else {
      fill.style.background = 'linear-gradient(90deg, var(--ok), #84cc16)';
    }

    const info = document.getElementById('context-window-info');
    info.innerHTML = `
      <strong>${data.token_count.toLocaleString()}</strong> / <strong>${data.context_window_size.toLocaleString()}</strong> tokens used
      (${data.tokens_remaining.toLocaleString()} remaining)
      <br>
      <span class="muted">Model: ${data.model} | Encoding: ${data.encoding}</span>
    `;
  }

  function renderTokenBreakdown(data) {
    const container = document.getElementById('token-breakdown');
    
    if (!data.tokens || data.tokens.length === 0) {
      container.innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">No tokens to display</div>';
      return;
    }

    // Show first 100 tokens in table, rest in summary
    const displayTokens = data.tokens.slice(0, 100);
    const remaining = data.tokens.length - 100;

    let html = `
      <table>
        <thead>
          <tr>
            <th>Index</th>
            <th>Token ID</th>
            <th>Token String</th>
            <th>Bytes</th>
          </tr>
        </thead>
        <tbody>
    `;

    displayTokens.forEach(token => {
      const tokenStr = escapeHtml(token.token_string);
      html += `
        <tr>
          <td>${token.index}</td>
          <td><code>${token.token_id}</code></td>
          <td><code style="background: var(--glass); padding: 2px 6px; border-radius: 4px;">${tokenStr}</code></td>
          <td>${token.byte_length}</td>
        </tr>
      `;
    });

    html += '</tbody></table>';

    if (remaining > 0) {
      html += `<div class="muted" style="margin-top: 12px; text-align: center;">... and ${remaining.toLocaleString()} more tokens</div>`;
    }

    container.innerHTML = html;
  }

  function renderTokenVisualization(data) {
    const container = document.getElementById('token-visualization');
    
    if (!data.tokens || data.tokens.length === 0) {
      container.innerHTML = '<div class="muted" style="text-align: center; padding: 40px;">No tokens to visualize</div>';
      return;
    }

    // Create visual representation with color-coded tokens
    let html = '';
    const colors = ['#7c3aed', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'];
    
    data.tokens.forEach((token, i) => {
      const color = colors[i % colors.length];
      const tokenStr = escapeHtml(token.token_string);
      html += `<span style="background: ${color}20; color: ${color}; padding: 2px 4px; margin: 2px; border-radius: 4px; border: 1px solid ${color}40; display: inline-block;" title="ID: ${token.token_id}, Index: ${token.index}">${tokenStr}</span>`;
    });

    container.innerHTML = html || '<div class="muted">No visualization available</div>';
  }

  function loadTokenizerExample() {
    const examples = [
      "Hello! How are you today? This is a test of the tokenizer system.",
      "The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet.",
      "Tokenization is the process of breaking down text into smaller units called tokens. These tokens are then used by language models to understand and generate text.",
      "In natural language processing, tokenization is a crucial step. It helps models understand context, manage memory, and process information efficiently.",
    ];
    const randomExample = examples[Math.floor(Math.random() * examples.length)];
    document.getElementById('tokenizer-input').value = randomExample;
  }

  function copyTokens() {
    if (!tokenizerState.currentResult) {
      showToast('No tokens to copy', 'warning');
      return;
    }
    const data = JSON.stringify(tokenizerState.currentResult, null, 2);
    navigator.clipboard.writeText(data);
    showToast('Tokens copied to clipboard', 'success');
  }

  function exportTokens() {
    if (!tokenizerState.currentResult) {
      showToast('No tokens to export', 'warning');
      return;
    }
    const data = JSON.stringify(tokenizerState.currentResult, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tokens-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Tokens exported', 'success');
  }

  // Utility
  function escapeHtml(s) {
    return s.replace(/[&<>"'`]/g, c => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;'}[c]));
  }

  // Make state available globally for inline handlers
  window.state = state;
  window.renderFilters = renderFilters;
  window.renderPresets = renderPresets;
  window.viewSchema = viewSchema;
  window.loadMetadataForDataset = loadMetadataForDataset;
  window.toggleEndpoint = toggleEndpoint;
  window.tryEndpoint = tryEndpoint;
  window.loadOfflineExample = loadOfflineExample;
  
  // Expose utility functions
  window.escapeHtml = escapeHtml;
  window.showToast = showToast;
  
  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    stopHealthMonitoring();
  });
})();
</script>
</body>
</html>
